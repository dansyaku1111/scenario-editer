{"version":3,"file":"rete-context-menu-plugin.min.js","sources":["src/presets/classic/factory.ts","src/presets/classic/index.ts","src/index.ts"],"sourcesContent":["import { NodeEditor } from 'rete'\nimport { BaseAreaPlugin } from 'rete-area-plugin'\n\nimport { Item } from '../../types'\nimport { BSchemes, ItemDefinition } from './types'\n\nexport function createItem<S extends BSchemes>(\n  [label, factory]: ItemDefinition<S>,\n  key: string | number,\n  context: { editor: NodeEditor<S>, area: BaseAreaPlugin<S, any> }\n): Item {\n  const item: Item = {\n    label,\n    key: String(key),\n    handler() {\n      /* noop */\n    }\n  }\n\n  if (typeof factory === 'function') {\n    return {\n      ...item,\n      async handler() {\n        const node = await factory()\n\n        await context.editor.addNode(node)\n\n        void context.area.translate(node.id, context.area.area.pointer)\n      }\n    } satisfies Item\n  }\n  return {\n    ...item,\n    handler() { /* do nothing */ },\n    subitems: factory.map((data, i) => createItem(data, i, context))\n  } satisfies Item\n}\n","import { NodeEditor } from 'rete'\nimport { BaseAreaPlugin } from 'rete-area-plugin'\n\nimport { Item, Items } from '../../types'\nimport { createItem } from './factory'\nimport { BSchemes, ItemDefinition } from './types'\n\n/**\n * Classic context menu preset.\n * Configures nodes/actions items for root and Delete/Clone items for nodes\n * @param nodes List of items\n * @example Presets.classic.setup([\n *  [\"Math\", [\n *    [\"Number\", () => new NumberNode()],\n *  ]]\n *])\n */\nexport function setup<Schemes extends BSchemes>(nodes: ItemDefinition<Schemes>[]) {\n  return function (context, plugin) {\n    const area = plugin.parentScope<BaseAreaPlugin<Schemes, any>>(BaseAreaPlugin)\n    const editor = area.parentScope<NodeEditor<Schemes>>(NodeEditor)\n\n    if (context === 'root') {\n      return {\n        searchBar: true,\n        list: nodes.map((item, i) => createItem(item, i, { editor, area }))\n      }\n    }\n\n    const deleteItem: Item = {\n      label: 'Delete',\n      key: 'delete',\n      async handler() {\n        if ('source' in context && 'target' in context) {\n          // connection\n          const connectionId = context.id\n\n          await editor.removeConnection(connectionId)\n        } else {\n          // node\n          const nodeId = context.id\n          const connections = editor.getConnections().filter(c => {\n            return c.source === nodeId || c.target === nodeId\n          })\n\n          for (const connection of connections) {\n            await editor.removeConnection(connection.id)\n          }\n          await editor.removeNode(nodeId)\n        }\n      }\n    }\n\n    const clone = context.clone?.bind(context)\n    const cloneItem: undefined | Item = clone && {\n      label: 'Clone',\n      key: 'clone',\n      async handler() {\n        const node = clone()\n\n        await editor.addNode(node)\n\n        void area.translate(node.id, area.area.pointer)\n      }\n    }\n\n    return {\n      searchBar: false,\n      list: [\n        deleteItem,\n        ...cloneItem\n          ? [cloneItem]\n          : []\n      ]\n    }\n  } satisfies Items<Schemes>\n}\n","import { BaseSchemes, Scope } from 'rete'\nimport { BaseArea, BaseAreaPlugin, RenderSignal } from 'rete-area-plugin'\n\nimport { Item, Items, Position } from './types'\n\nexport * as Presets from './presets'\n\n/**\n * Context menu plugin props\n * @priority 8\n */\nexport type Props<Schemes extends BaseSchemes> = {\n  /**\n   * delay before hiding context menu\n   * @deprecated Use the `delay` option of the rendering plugin preset.\n   */\n  delay?: number\n  /** menu items, can be produced by preset */\n  items: Items<Schemes>\n}\nexport type RenderMeta = { filled?: boolean }\n\n/**\n * Signal types produced by ContextMenuPlugin instance\n * @priority 10\n */\nexport type ContextMenuExtra =\n  | RenderSignal<'contextmenu', {\n    items: Item[]\n    onHide(): void\n    searchBar?: boolean\n  }>\n\ntype Requires<Schemes extends BaseSchemes> =\n  | { type: 'contextmenu', data: { event: MouseEvent, context: 'root' | Schemes['Node'] | Schemes['Connection'] } }\n  | { type: 'unmount', data: { element: HTMLElement } }\n  | { type: 'pointerdown', data: { position: Position, event: PointerEvent } }\n\n/**\n * Plugin for context menu.\n * Responsible for initialing rendering of context menu with predefined items.\n * @priority 9\n * @emits render\n * @emits unmount\n * @listens unmount\n * @listens contextmenu\n * @listens pointerdown\n */\nexport class ContextMenuPlugin<Schemes extends BaseSchemes> extends Scope<never, [Requires<Schemes> | ContextMenuExtra]> {\n  /**\n   * @param props Properties\n   */\n  constructor(private props: Props<Schemes>) {\n    super('context-menu')\n  }\n\n  setParent(scope: Scope<Requires<Schemes>>): void {\n    super.setParent(scope)\n\n    const area = this.parentScope<BaseAreaPlugin<Schemes, BaseArea<Schemes>>>(BaseAreaPlugin)\n    const container: HTMLElement = (area as any).container\n\n    if (!container || !(container instanceof HTMLElement)) throw new Error('container expected')\n\n    const element = document.createElement('div')\n\n    element.style.display = 'none'\n    element.style.position = 'fixed'\n\n    // eslint-disable-next-line max-statements\n    this.addPipe(context => {\n      const parent = this.parentScope()\n\n      if (!context || typeof context !== 'object' || !('type' in context)) return context\n      if (context.type === 'unmount') {\n        if (context.data.element === element) {\n          element.style.display = 'none'\n        }\n      } else if (context.type === 'contextmenu') {\n        context.data.event.preventDefault()\n        context.data.event.stopPropagation()\n\n        const { searchBar, list } = this.props.items(context.data.context, this)\n\n        container.appendChild(element)\n        element.style.left = `${context.data.event.clientX}px`\n        element.style.top = `${context.data.event.clientY}px`\n        element.style.display = ''\n\n        void parent.emit({\n          type: 'render',\n          data: {\n            type: 'contextmenu',\n            element,\n            searchBar,\n            onHide() {\n              void parent.emit({ type: 'unmount', data: { element } })\n            },\n            items: list\n          }\n        })\n      } else if (context.type === 'pointerdown') {\n        if (!context.data.event.composedPath().includes(element)) {\n          void parent.emit({ type: 'unmount', data: { element } })\n        }\n      }\n      return context\n    })\n  }\n}\n"],"names":["createItem","_ref","key","context","_ref2","_slicedToArray","label","factory","item","String","handler","_objectSpread","_asyncToGenerator","_regeneratorRuntime","mark","_callee","node","wrap","_context","prev","next","sent","editor","addNode","area","translate","id","pointer","stop","subitems","map","data","i","nodes","plugin","_context$clone","parentScope","BaseAreaPlugin","NodeEditor","searchBar","list","deleteItem","connectionId","nodeId","connections","_iterator","_step","connection","removeConnection","getConnections","filter","c","source","target","_createForOfIteratorHelper","s","n","done","value","t0","e","f","finish","removeNode","clone","bind","cloneItem","_callee2","_context2","concat","_toConsumableArray","ContextMenuPlugin","_Scope","props","_this","_classCallCheck","_callSuper","_inherits","scope","_this2","this","container","HTMLElement","Error","element","document","createElement","style","display","position","addPipe","parent","_typeof","type","event","preventDefault","stopPropagation","_this2$props$items","items","appendChild","left","clientX","top","clientY","emit","onHide","composedPath","includes","Scope"],"mappings":"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"}